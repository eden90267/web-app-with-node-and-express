# chap15. REST API與JSON

現在我們將焦點轉移到，讓資料與功能可供其他程式使用。

本章中，我們會在app加入一個Web服務。“**Web服務**”這個名詞是一個通用名詞。代表**所有可以透過HTTP操作的API**。Web服務概念到最近，這個技術仍然很古板、難懂且過度複雜。目前還有一些系統在使用這些技術(例如SOAP與WSDL)，而且也有Node套件可協助你與這些系統連接。但我們不討論它，而是將焦點放在提供所謂的“RESTful”服務，這容易連接多了。

REST的縮寫“representational state transfer”，**RESTful代表滿足REST原則的Web服務**。REST的正式定義很複雜，但REST基本上是一個介於用戶端與伺服器之間的**無狀態連結**。REST的正式定義也指定**服務要能被緩存**，而且該**服務可以層次化**(也就是說，當你使用REST API時，在它下面可能有其他的REST API)。

從實際的角度來看，HTTP的限制確實讓人難以建立非RESTful的API。

## JSON與XML

提供API的目的，在於讓你有一個共用的語言可以溝通。通訊的一部分跟我們有關：我們必須使用HTTP方法來與伺服器溝通。除此之外，我們就可以自由地使用任何想要用的資料語言。傳統上，XML已成為受歡迎的選擇。雖XML並沒有特別複雜，但Douglas Crockford看到他有輕量化的空間，因而造成JavaScript物件標示法(JSON)的誕生。它除了非常JavaScript友善之外，它的另一個優點是比XML更容易手動編寫。

## 我們的API

實作API之前，先做好規劃：

- GET /api/attractions

    抓取景點。將lat、lng與radius作為查詢字串參數，並回傳景點清單。

- GET /api/attractions/:id

    回傳景點ID

- POST /api/attraction

    在查詢內文中，取用lat、lng、name、description與email。新加入的景點會進入審核佇列。

- PUT /api/attraction/:id

    更新既有的景點。取用景點ID、lat、lng、name、description與email。更新動作會進入審核佇列。

- DEL /api/attraction/:id

    刪除一個景點。取用景點ID、email與reason。刪除的動作會進入審核佇列。
    
添加景點、取回景點，及列出景點。

## API錯誤回報

HTTP API的錯誤回報通常使用HTTP狀態碼來實作：

- 200(OK)
- 500(內部伺服器錯誤)

但大多數應用程式，並非所有東西都可以(或應該)被粗略分類為“成功”或“失敗”。一般情況下，錯誤可被分成下列的幾類：

- 災難性錯誤

    造成伺服器不穩定或進入未知狀態的錯誤。通常這是未被處理的例外所產生的結果。要從災難性錯誤回覆，最安全方式是重新啟動伺服器。理想情況，等待的請求都會收到500回應碼，如果失敗太嚴重，伺服器可能完全無法回應，請求就會逾時。

- 可回覆的伺服器錯誤

    不需重啟伺服器，或其他的英雄式行動。這種錯誤是因為伺服器意外的錯誤狀況(例如，資料庫連結無法使用)。這問題可能是暫時或永久的。500回應碼適用於這種狀況。

- 用戶端錯誤

    通常是用戶端犯錯造成，通常是缺少參數或參數不正確。這不適合500回應碼。你有幾種選擇：回應200狀態碼，並在回應內文中說明錯誤，或另外使用適當的HTTP狀態碼，試著說明錯誤。建議第二種。最好用回應碼是404(未發現)、400(錯誤的請求)及401(未經授權)。此外，回應內文應明確解釋錯誤，甚至錯誤訊息可含有文件的連結。
    
在我們的應用程式中，會在內文中使用HTTP回應碼與錯誤訊息的結合。這種方法與jQuery相容。

## 跨來源資源共享(CORS)

如果你要發布API，可能想要讓其他人也可以使用API，這會產生**跨站HTTP請求**。跨站HTTP請求一直是受到攻擊的對象，因此被**同源政策**限制，它會限制何處的指令碼可被載入。具體來說，**協定**、**網域**及**連接埠**都必須符合。這可以讓其他的網站使用你的API，這就是CORS的源起。CORS可讓你根據各種情況來解除限制，甚至讓你**具體列出哪些網域可以存取該指令碼**。CORS是透過**Access-Control-Allow-Origin**標頭來實作的。要在Express應用程式實作它，最簡單方式是使用cors套件(npm install --save cors)，要在你的應用程式中使用CORS：

```
app.use(require('cors')());
```