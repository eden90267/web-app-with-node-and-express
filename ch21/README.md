# chap21. 開張

這章會學到網域註冊及託管服務，以及預備環境變成產品的技術、部署技術，及選擇產品服務要考慮的事情。

## 網域註冊及託管

IP位址難識別，因此才會有**網域名稱**的出現。就現實世界而言，它們就像企業名稱與實際地址之間的關係。實際地址會變，但抽象機制的企業名稱，還是會讓人家找到它。

主機(Hosting)，可比喻為到達實際地址時看到的建築物。

### 網域名稱系統

Domain Name System(DNS)是負責將網域名稱對應至IP位址的東西。

### 安全

主機服務被駭客破解，但你還保有網域的控制權，你仍可找到一個新主機，並重導向網域。反過來說，如果網域被破解，就真的麻煩大了。

結論就是**你必須非常認真地保護網域**，或許應該比保護你的資料還要認真(有品質的網域註冊並不是很貴)。

你應該採取良好的網域註冊安全措施。強健、獨特的密碼與適當的密碼衛生習慣。較佳的選擇是採用雙因素驗證的註冊機構。這裡建議：Name.com與Nameheap.com，它們都提供雙因素驗證，且線上控制面板都很簡單且強健。

當你註冊網域時，你必須提供與該網域無關的第三方email地址(Google或Outlook帳號)。

### 頂級網域

網域結尾的地方，就是所謂的**頂級網域**(TLD)。TLD有兩種：國家代碼TLD與一般TLD。國家代碼都是為了提供地理分類。但取得這些TLD對象有一些限制。

一般TLD包括熟悉的：.com、.net、.gov、.fed、.mil與.edu。受限制的TLD有.gov、.fed、.edu、.mil。

ICANN是最終負責TLD的機構。

選擇網域要考慮它的使用方式。短的、容易輸入的，長的、更適合行銷的。

### 子網域

TLD在網域的後面，但子網域在前面。到目前為止，最常見的子網域是www。但這子網域我從來就不特別關心。

建議子網域劃分網站或服務各個明顯不同的部分。例如：用子網域來讓你API可在*api.meadowlarktrave.com*取得是很好的用法。微網站(外觀明顯與你的其它網站不同的網站，通常用來凸顯單一產品或主題)也是使用子網域的好對象。子網域還有一種聰明的使用方式：就是將管理介面與公用介面分開(*admin.meadowlarktravel.com*僅供員工使用)。

除非你指定其他的東西，否則你的域名註冊機構會將伺服器的所有交通重新導向，無論子網域為何。接下來，是由你的伺服器(或代理伺服器)來根據子網域採取適當的動作。

### 域名伺服器

讓網域可以動作的“膠水”是域名伺服器。

要注意主機供應商給的IP位置，動態IP會變，靜態IP的註冊DNS解析器可省去中間人，但取得靜態IP位址的花費會比動態還要高。

如果是網域直接對應至網站(跳過主機的域名伺服器)，將會添加一筆A紀錄或CNAME紀錄。A紀錄會將網域名稱直接對應一個IP位址，而CNAME會將一個網域名稱對應至其他的名稱。CNAME紀錄通常比較缺乏彈性，所以A紀錄比較適合。

無論你用哪一種技術，網域對應通常會被積極地緩存，代表當你改變網域紀錄時，可能會花費48小時，你的網域才會被附加到新的伺服器。記得，這也跟地理位置有關。24小時是美國大陸正確解析，48小時是國際解析。

若要精確上線，就不要依賴DNS變更。請修改你的伺服器來重新導向到“即將上映”的網站或網頁，並在實際切換前改變DNS。

### 主機

#### 傳統主機，或雲端主機？

雲端主機通常代表某種商品化的計算機資源。也就是說，我們不再將“伺服器”當成一種獨特的物理實體：他只是一種類似的雲端資源，而且都一樣好。

唯一差別在於你是否知道(與**在乎**)你的app的伺服器究竟在哪裡，以及知道它是位於雲端上**某個**伺服器，而且它可以在你不知道的情況下輕鬆地移往不同的伺服器(或**在乎**)。

雲端主機也是非常**虛擬化**的。代表你的app伺服器不一定是實體機器，而是在實體伺服器上運行的虛擬機器。這個概念不是由雲端主機引入的，但它已經成為雲端主機的**代名詞**。

雲端主機，它代表了微妙的思維變化。它其實沒什麼不一樣的地方：當你收到主機帳單的時候，你其實是付錢給同樣的服務：有一些人負責管理實體硬體及網路，讓你的Web應用程式可以運行。唯一的改變是，**你離硬體更遠了**。

我相信“傳統”主機最終將會完全消失。

#### XaaS

在考慮雲端主機，你會遇到SaaS、PaaS與IaaS：

- 以軟體服務SaaS

    代表提供給你的軟體(網站、app)：你只要使用它們即可。

- 平台服務PaaS

    提供所有的基礎結構給你(作業系統、網路——它們都被管理)。你要做的就是編寫你的應用程式。

- 基礎架構服務IaaS

    IaaS給你最佳的彈性，但很貴。你會有許多虛擬機器與一個連結它們的基本網路。接著你可以安裝或維護作業系統、資料庫及網路政策。除非你需要這種等級的環境控制權，否則通常只要使用PaaS即可。

#### 龐然大物

Microsoft、Amazon與Google都提供雲端計算服務。

筆者推薦免費試用Azure來評估它。Microsoft為它的主流服務都提供Node API，包括他們的雲端存儲服務。除傑出的Node主機之外，Azure也提供Git部署，這是一種優秀的雲端存儲系統，並充分支援MongoDB。Azure的缺點是沒有提供小型專案的價格區間。如果你的產品要使用Azure，可能每個月至少要花$80。

請記得，你可以用這個價格輕鬆地託管許多專案。如果要整合大量的網站，這也是實惠的價格。

Amazon提供最全面的資源組，包括SMS、雲端存儲、email服務、付款服務(電子商務)、DNS及其他。

Google雲端平台還沒有提供Node主機的選項，但可透過IaaS服務來託管。

除了三巨頭，你也可以考慮Joyent，它目前已深度參與Node開發。Joyent的合作夥伴Nodejitsu是這領域的專家，提供Node專用的主機。它們提供獨特的開發選項：私用的npm存儲庫。如果Git部署不夠吸引你，你可研究Nodejitsu的npm部署。

#### 精緻主機

較小型的託管服務，它們重心通常放在客戶服務與支援上。對於個人專案，筆者曾經使用WebFaction。

#### 部署

推薦Git部署。Azure提供開箱即用服務，而且它們實作很傑出，展示Git部署的承諾。

master -merge-> staging做實驗，假使東西被核准可以成為產品線，再由master -merge-> production。這樣staging與production的關係比較少。staging可開多個來做實驗不同功能。

回復變更？推薦的方法是將production(及staging分支，如果你要的話)視為一次性的：它們真的只是你的主要分支在不同時間點的反射。如果你需要回覆變更，接下來在你的production分支作`git reset --hard <old commit id>`，接下來`git push origin production --force`。基本上，這是“重新編寫歷史”，重新編寫的歷史紀錄這會讓你陷入麻煩。

#### 在Azure部署

要將主應用程式檔名改為server.js。Azure預期的主應用程式部署名稱。

#### 手動Git部署

```
git pull --ff-only
npm install
node meadowlark
```

但你最好尋找可系統自動化的方法。

#### 使用Elastic Beanstalk來做Amazon部署

可使用AWS的Elastic Beanstalk(EB)來用Git做自動部署。

## 結論

部署網站是令人興奮的時刻。最重要的是在網站真正上線之前，盡早啟動產品部署。你不需掛上網域，因此不會讓公眾知道，如果你在啟動日期之前，已經將網站部署到產品伺服器五六次了，成功啟動的機會將會提升許多。理想狀態下，你的網站在正式啟用前，已經可以在產品伺服器上運行了。